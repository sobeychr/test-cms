---
import DefaultLayout from '@layouts/Default.astro';
import styles from '@styles/pages/logs.module.scss';
---

<DefaultLayout>
  <h1>Logs</h1>
  <section>
    <div class={styles.body} id="logs-body"></div>
  </section>

  <template id="entry">
    <article class={styles.entry}>
      <input type="checkbox" name="isApiRequest" readonly value="1" />

      <header>
        <span class={styles.method} data-method="{method}">{'{method}'}</span>
        <span class={styles.pathname}>{'{pathname}'}</span>
        <span class={styles.uuid}>{'{uuid}'}</span>
        <span data-time="{delay}">{'{delay}'}ms</span>
        <span>{'{start}'}</span>
        <span>{'{end}'}</span>
      </header>
    </article>
  </template>
</DefaultLayout>

<script>
  import { API_PREFIX } from '@utils/configs';
  // import { dateToFullString } from '@utils/date';
  import { populateTemplate } from '@utils/dom';
  import { useRequest } from '@utils/request';

  (function () {
    const DELAY_LOW = 300;
    const DELAY_MEDIUM = 700;
    const DELAY_HIGH = 1200;

    const callRequest = async () => {
      const resp = await useRequest({
        url: `${API_PREFIX}v2/logs`,
      });

      populateLogs(resp);
    };

    const populateLogs = (logs) => {
      populateTemplate(
        document.querySelector('#entry') as HTMLTemplateElement,
        document.querySelector('#logs-body') as HTMLElement,
        logs,
      );

      document.querySelectorAll('#logs-body span[data-time]').forEach((entry) => {
        const time = parseInt(entry.getAttribute('data-time'), 10) || 0;
        const className =
          (time < DELAY_LOW && 'low') ||
          (time > DELAY_HIGH && 'high') ||
          (time > DELAY_MEDIUM && 'medium') ||
          '';

        entry.classList.add(className);
      });
    };
    callRequest();
  })();
</script>
